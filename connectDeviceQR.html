<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>WebRTC QR Signaling Demo</title>
  <style>
    textarea { width: 100%; height: 60px; margin: 6px 0; }
    button { margin: 5px; }
    #qrOffer, #qrAnswer { margin: 10px 0; }
  </style>
  <!-- QRCode.js CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
   <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>
  <h2>WebRTC QR Code Signaling</h2>

  <!-- Caller section -->
  <button id="createOfferBtn">Create Offer (Caller)</button><br>
  <div id="qrOffer"></div>
  <label>Offer SDP (copy/share with Receiver):</label><br>
  <textarea id="offerSDP" readonly></textarea><br>

  <!-- Receiver section -->
  <label>Paste Offer SDP (from Caller):</label><br>
  <textarea id="remoteOfferSDP"></textarea><br>
  <button id="receiveOfferBtn">Receive Offer & Create Answer</button><br>
  <div id="qrAnswer"></div>
  <label>Answer SDP (copy/share with Caller):</label><br>
  <textarea id="answerSDP" readonly></textarea><br>

  <label>Paste Answer SDP (from Receiver):</label><br>
  <textarea id="remoteAnswerSDP"></textarea><br>
  <button id="receiveAnswerBtn">Receive Answer (Caller)</button><br><br>

  <label>Send Message:</label>
  <input type="text" id="messageInput" />
  <button id="sendMessageBtn">Send</button>

  <h3>Messages:</h3>
  <pre id="messages"></pre>

  <script>
    let localConnection, remoteConnection, dataChannel, receiveChannel;
    const offerSDPTextarea = document.getElementById('offerSDP');
    const answerSDPTextarea = document.getElementById('answerSDP');
    const remoteOfferSDPTextarea = document.getElementById('remoteOfferSDP');
    const remoteAnswerSDPTextarea = document.getElementById('remoteAnswerSDP');
    const qrOfferDiv = document.getElementById('qrOffer');
    const qrAnswerDiv = document.getElementById('qrAnswer');
    const messagesPre = document.getElementById('messages');
    const messageInput = document.getElementById('messageInput');

    const config = { iceServers: [] };

    function appendMessage(msg) {
      messagesPre.textContent += msg + '\n';
    }

    function generateQR(div, data) {
      div.innerHTML = "";
      // QR Code.js limitation: avoid generating very large QR (see note).
      try {
        new QRCode(div, { text: data, width: 256, height: 256 });
      } catch (err) {
        div.innerHTML = "QR generation error: " + err;
      }
    }

    document.getElementById('createOfferBtn').onclick = async () => {
      qrOfferDiv.innerHTML = "";
      localConnection = new RTCPeerConnection(config);

      dataChannel = localConnection.createDataChannel('dataChannel');
      setupDataChannel(dataChannel);

      localConnection.onicecandidate = event => {
        if (event.candidate === null) {
          const offerSDP = JSON.stringify(localConnection.localDescription);
          offerSDPTextarea.value = offerSDP;
          generateQR(qrOfferDiv, offerSDP);
        }
      };

      try {
        const offer = await localConnection.createOffer();
        await localConnection.setLocalDescription(offer);
      } catch (e) {
        alert('Error creating offer: ' + e);
      }
    };

    document.getElementById('receiveOfferBtn').onclick = async () => {
      qrAnswerDiv.innerHTML = "";
      const offerSDPString = remoteOfferSDPTextarea.value.trim();
      if (!offerSDPString) { alert("Paste Offer SDP."); return; }
      let offerSDP;
      try { offerSDP = JSON.parse(offerSDPString); }
      catch (err) { alert("Invalid Offer SDP JSON."); return; }

      remoteConnection = new RTCPeerConnection(config);

      remoteConnection.ondatachannel = event => {
        receiveChannel = event.channel;
        setupDataChannel(receiveChannel);
      };

      remoteConnection.onicecandidate = event => {
        if (event.candidate === null) {
          const answerSDP = JSON.stringify(remoteConnection.localDescription);
          answerSDPTextarea.value = answerSDP;
          generateQR(qrAnswerDiv, answerSDP);
        }
      };

      try {
        await remoteConnection.setRemoteDescription(offerSDP);
        const answer = await remoteConnection.createAnswer();
        await remoteConnection.setLocalDescription(answer);
      } catch (e) {
        alert('Error receiving offer: ' + e);
      }
    };

    document.getElementById('receiveAnswerBtn').onclick = async () => {
      const answerSDPString = remoteAnswerSDPTextarea.value.trim();
      if (!answerSDPString) { alert("Paste Answer SDP."); return; }
      let answerSDP;
      try { answerSDP = JSON.parse(answerSDPString); }
      catch (err) { alert("Invalid Answer SDP JSON."); return; }
      try {
        await localConnection.setRemoteDescription(answerSDP);
        appendMessage('Connection established! Send a test message.');
      } catch (e) {
        alert('Error receiving answer: ' + e);
      }
    };

    function setupDataChannel(channel) {
      channel.onopen = () => appendMessage('Channel open');
      channel.onclose = () => appendMessage('Channel closed');
      channel.onmessage = e => appendMessage('Received: ' + e.data);
    }

    document.getElementById('sendMessageBtn').onclick = () => {
      const msg = messageInput.value;
      if (dataChannel && dataChannel.readyState === 'open') {
        dataChannel.send(msg);
        appendMessage('Sent: ' + msg);
        messageInput.value = '';
      } else if (receiveChannel && receiveChannel.readyState === 'open') {
        receiveChannel.send(msg);
        appendMessage('Sent: ' + msg);
        messageInput.value = '';
      } else {
        appendMessage('Channel not open for sending.');
      }
    };
  </script>
</body>
</html>
