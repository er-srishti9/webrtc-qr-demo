<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Offline WebRTC Manual Signaling</title>
  <style>textarea{width:100%;height:80px;}</style>
</head>
<body>
<h2>WebRTC Manual Signaling Demo</h2>

<!-- Section for Caller -->
<button onclick="createOffer()">1. Create Offer (Device A)</button>
<textarea id="offerSDP" placeholder="Offer SDP will appear here"></textarea>
<!-- Section for Receiver -->
<textarea id="remoteOfferSDP" placeholder="Paste Offer SDP here"></textarea>
<button onclick="receiveOffer()">2. Receive Offer & Create Answer (Device B)</button>
<textarea id="answerSDP" placeholder="Answer SDP will appear here"></textarea>
<textarea id="remoteAnswerSDP" placeholder="Paste Answer SDP here"></textarea>
<button onclick="receiveAnswer()">3. Receive Answer (Device A)</button>
<hr>
<input id="messageInput" placeholder="Enter message"/>
<button onclick="sendMessage()">Send</button>
<pre id="messages"></pre>

<script>
let localConnection, remoteConnection, sendChannel, receiveChannel;

// Device A: create offer and data channel
function createOffer() {
  localConnection = new RTCPeerConnection();
  sendChannel = localConnection.createDataChannel("data");
  sendChannel.onmessage = e => showMsg('Peer: ' + e.data);
  sendChannel.onopen = () => showMsg('Data channel open');
  sendChannel.onclose = () => showMsg('Data channel closed');
  localConnection.onicecandidate = e => {
    if (e.candidate === null) {
      document.getElementById('offerSDP').value = JSON.stringify(localConnection.localDescription);
    }
  };
  localConnection.createOffer()
    .then(offer => localConnection.setLocalDescription(offer));
}

// Device B: receive offer, create answer
function receiveOffer() {
  let sdp = document.getElementById('remoteOfferSDP').value;
  if (!sdp) return alert("Paste Offer SDP first!");
  remoteConnection = new RTCPeerConnection();
  remoteConnection.ondatachannel = event => {
    receiveChannel = event.channel;
    receiveChannel.onmessage = e => showMsg('Peer: ' + e.data);
    receiveChannel.onopen = () => showMsg('Data channel open');
    receiveChannel.onclose = () => showMsg('Data channel closed');
  };
  remoteConnection.onicecandidate = e => {
    if (e.candidate === null) {
      document.getElementById('answerSDP').value = JSON.stringify(remoteConnection.localDescription);
    }
  };
  remoteConnection.setRemoteDescription(new RTCSessionDescription(JSON.parse(sdp)))
    .then(() => remoteConnection.createAnswer())
    .then(answer => remoteConnection.setLocalDescription(answer));
}

// Device A: finalize by pasting the answer
function receiveAnswer() {
  let sdp = document.getElementById('remoteAnswerSDP').value;
  if (!sdp) return alert("Paste Answer SDP first!");
  localConnection.setRemoteDescription(new RTCSessionDescription(JSON.parse(sdp)));
}

// Send messageâ€”works on whichever peer created a data channel
function sendMessage() {
  let msg = document.getElementById('messageInput').value;
  if (sendChannel && sendChannel.readyState === 'open') {
    sendChannel.send(msg);
    showMsg('You: ' + msg);
  } else if (receiveChannel && receiveChannel.readyState === 'open') {
    receiveChannel.send(msg);
    showMsg('You: ' + msg);
  } else {
    alert('Data channel not open yet!');
  }
}

function showMsg(msg) {
  document.getElementById('messages').textContent += msg + '\n';
}
</script>
</body>
</html>
